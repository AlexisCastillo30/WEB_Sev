<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OTTO - Licencias</title>
  <link rel="stylesheet" href="../assets/css/styles.css" />
</head>
<body>
  <header class="header">
    <!-- ... -->
  </header>

  <main class="profile-main">
    <h1>Perfil de Usuario</h1>
    <h2>Licencias</h2>
    <table id="licensesTable" class="licenses-table">
      <thead>
        <tr>
          <th>Name Lic</th>
          <th>Status</th>
          <th>Fecha de Vencimiento</th>
          <th>Días Restantes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>© 2025 TuCompañía</p>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script src="../assets/js/scripts.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthAndUpdateUI();

      // Revisar si Cognito devolvió ?code=
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');

      if (authCode) {
        exchangeCodeForTokens(authCode);
      } else {
        // Si ya tenemos token => cargar licencias
        const accessToken = sessionStorage.getItem('accessToken');
        if (accessToken) {
          loadLicenses(accessToken);
        } else {
          // Forzar login
          window.location.href = 'https://api.ottoapis.com/auth/login';
        }
      }
    });

    function exchangeCodeForTokens(code) {
      fetch(`https://api.ottoapis.com/exchangeCode?code=${code}`)
        .then(resp => resp.json())
        .then(data => {
          if (data.error) {
            console.error("Error en exchangeCode:", data.error);
            return;
          }
          // Guardar tokens
          sessionStorage.setItem('accessToken', data.access_token);
          sessionStorage.setItem('idToken', data.id_token);

          // Quitar el ?code de la URL
          window.history.replaceState({}, document.title, window.location.pathname);

          checkAuthAndUpdateUI();
          loadLicenses(data.access_token);
        })
        .catch(err => {
          console.error("Error en intercambio de code:", err);
        });
    }

    function loadLicenses(accessToken) {
      const decoded = jwt_decode(accessToken);
      const userSub = decoded.sub;
      if (!userSub) {
        console.error("Token sin 'sub'");
        return;
      }

      const url = `https://api.ottoapis.com/usuarios/${userSub}/licencias`;
      fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
      .then(r => r.json())
      .then(data => {
        const licenses = data.items || data;
        renderLicenses(licenses);
      })
      .catch(err => console.error("Error al cargar licencias:", err));
    }

    function renderLicenses(licenses) {
      const tbody = document.getElementById('licensesTable').querySelector('tbody');
      tbody.innerHTML = '';

      licenses.forEach(lic => {
        const tr = document.createElement('tr');

        // Nombre
        const tdName = document.createElement('td');
        tdName.textContent = lic.name || lic.product_id || 'N/A';
        tr.appendChild(tdName);

        // Status
        const tdStatus = document.createElement('td');
        if (lic.expires_at) {
          const expDate = new Date(lic.expires_at);
          tdStatus.textContent = expDate > new Date() ? 'Activa' : 'Inactiva';
        } else {
          tdStatus.textContent = 'Desconocido';
        }
        tr.appendChild(tdStatus);

        // Fecha
        const tdExp = document.createElement('td');
        tdExp.textContent = lic.expires_at || '';
        tr.appendChild(tdExp);

        // Días restantes
        const tdDays = document.createElement('td');
        if (lic.expires_at) {
          const diffMs = new Date(lic.expires_at) - new Date();
          const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
          tdDays.textContent = diffDays <= 0 ? 'Expirada' : diffDays;
        } else {
          tdDays.textContent = '';
        }
        tr.appendChild(tdDays);

        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
